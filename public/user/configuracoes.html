<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Início</title>
    <link rel="stylesheet" href="../css/partials/navbar.css" />
    <link rel="stylesheet" href="../css/index.css" />
    <link rel="stylesheet" href="../css/pages/configuracoes/config-doador.css" />
        <link rel="stylesheet" href="../css/partials/search.css">
          <link rel="stylesheet" href="../css/carregamento.css" />
  </head>
  <body>
                  <div id="loading-screen">
        <div class="loader-container">
            <div class="logo-reveal"></div>
            <div class="carregamentoTexto">
                <h1>Carregando</h1>
                <div class="dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </div>
    <header>
      <nav class="navbar">
        <div
          class="flex"
          style="justify-content: flex-start; width: 100%; gap: 1.5rem"
        >
          <div style="line-height: 50px">
            <button class="hamburger" id="hamburger"></button>
          </div>
          <ul class="nav-links" id="navlinks">
            <li><a href="feed.html">Explorar</a></li>
            <li><a href="ongsFiltro.html">ONGs</a></li>
          </ul>
          <a class="nav-title" href="../user/feed.html"
            ><img
              src="../assets/svg/Logo UneONG FINAL.svg"
              alt=""
              width="80"
              height="80"
          /></a>
        </div>

        <div style="display: flex; flex-direction: column; position: relative;">
        <input type="text" name="txtbuscar" id="txtbuscar" class="buscar" placeholder="Procure uma ong..." />
        <div id="results" class="results" ></div>
      </div>
        <label for="txtbuscar"><img src="../assets/png/icones/icone_buscar.png" class="buscarIcon" alt=""></label>

        <div
          class="nav-elements"
          style="width: 100px; justify-content: flex-end; padding-left: 1rem"
        >
          <div class="icon-menu">
            <img
              src="../assets/png/user-example.png"
              alt=""
              id="dropdown-perfil"
            />
          </div>
                          <div class="dropdown" id="dropdownMenu">
                    <div class="flex" style="width: 100%;">
                        <img class="foto-perfil" src="../assets/jpg/foto-perfil-exemplo.jpg" alt="">
                        <div class="mn-part1">
                            <p class="name-account">Juscelino Lima</p>
                            <p class="email-account">juscelinolima@gmail.com</p>
                            <a class="perfil-account" href="perfil.html">Seu perfil ➞</a>
                        </div>
                    </div>
                    <div class="mn-part2">
                        <ul>
                            <li><a href="configuracoes.html"><img src="../assets/png/icones/icone_configuracoes.png" alt="" style="width: 25px; margin-right: 7px; vertical-align: middle;">Configurações</a></li>
                        </ul>
                    </div>
                </div>
        </div>
      </nav>
    </header>

    <div id="overlay"></div>

    <main>
      <!--seção fixa de configurações-->
      <section class="fixed-settings-sidebar">
        <div class="title-container">
          <img
            src="../assets/png/icones/icone_configuracoes.png"
            alt="icone configuracoes"
          />
          <h1>Configurações</h1>
        </div>
        <div class="elementos-config">
          <ul>
            <li>
              <img src="../assets/png/icones/icone_perfil.png" alt="perfil" /><a
                id="link-perfil"
                style="color: #e74c3c; font-weight: bold"
                >Perfil</a
              >
            </li>
            <li>
              <img
                src="../assets/png/icones/icone_sair.png"
                alt="outras informacoes"
              /><a class="link-sair">Sair</a>
            </li>
          </ul>
        </div>
      </section>

      <!--seção de perfil -->
      <section class="display-config" id="secao-perfil">
        <div class="informacoes-perfil">
          <div
            class="imagem-fundo"
            tabindex="0"
            id="imagem-fundo"
            onclick="AcionarFundo()"
          >
            <input
              type="file"
              accept="image/*"
              class="input-imagem-fundo"
              id="input_imagem_fundo"
            />
            <span class="span-imagem-fundo"></span>
          </div>

          <div
            class="icone-perfil"
            tabindex="0"
            id="icone-perfil"
            onclick="AcionarIcone()"
          >
            <input
              type="file"
              accept="image/*"
              class="input-icone-perfil"
              id="input_icone_perfil"
              name="input-icone-perfil"
            />
            <span class="span-icone-perfil"></span>
          </div>

          <div class="info-editar">
            <div class="linha">
              <div class="campo-editar-container">
                <h2>Nome:</h2>
                <input type="text" id="txtnome" />
                <img src="../assets/png/icones/icone_editar.png" alt="Editar" />
              </div>

              <div class="campo-editar-container">
                <h2>Email:</h2>
                <input type="email" id="txtemail" />
                <img src="../assets/png/icones/icone_editar.png" alt="Editar" />
              </div>
            </div>

            <div class="linha">
              <div class="campo-editar-container">
                <h2>Senha:</h2>
                <input type="text" id="txtsenha" />
                <img src="../assets/png/icones/icone_editar.png" alt="Editar" />
              </div>
            </div>
          </div>
        </div>
        <div class="botao-salvarAlteracoes">
          <button  id="Alterar">Salvar Alterações</button>
        </div>
      </section>
    </main>

    <div id="modalsairconta" Open>
      <div class="modal-header">
        <h1 class="modal-title">Sair</h1>
        <button class="close-modal" id="fecharSaida">X</button>
      </div>

      <div class="modal-body">
        <div class="desc-sairconta">
          <span>Você tem certeza que deseja sair da conta? </span>
        </div>

        <div class="opcoes-sairconta">
          <button id="btn-cancelar-sairconta">Cancelar</button>

          <button id="btn-sair-sairconta">Sair</button>
        </div>
      </div>
    </div>
    
  <script>
    window.onload = async () => {
      try {
        const res = await fetch("/api/configUser", {
          method: "GET",
          credentials: "include" // necessário para enviar o cookie da sessão
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error);

          window.location.href = "../cadastros/login-doador.html";
          return;
        }


        document.querySelector(".foto-perfil").src = data.foto_perfil_usuario
        document.getElementById("txtnome").value = data.Nome_user;
        document.querySelector(".name-account").textContent = data.Nome_user;
        document.getElementById("txtemail").value = data.Email_user;
        document.querySelector(".email-account").textContent = data.Email_user;
        document.getElementById("txtsenha").value = data.Senha_user;
        console.log(data);
      } catch (err) {
        console.error("Erro ao carregar dados:", err);
      }
    };

    let form = document.getElementById("Alterar")
    form.addEventListener('click', async function (e) {
      e.preventDefault();
      const formData = new FormData();
      const foto_perfil_usuario = document.getElementById("input_icone_perfil").files[0];
      const foto_header_usuario = document.getElementById("input_imagem_fundo").files[0];

      const Nome_user = document.getElementById('txtnome').value;
      const Email_user = document.getElementById('txtemail').value;
      const Senha_user = document.getElementById('txtsenha').value;

      if (foto_perfil_usuario) formData.append("input_icone_perfil", foto_perfil_usuario);
      if (foto_header_usuario) formData.append("input_imagem_fundo", foto_header_usuario);
      formData.append("txtnome", Nome_user);
      formData.append("txtemail", Email_user);
      formData.append("txtsenha", Senha_user);

      const res = await fetch("/api/user/atualizar", {
        method: 'PUT',
        
        body: formData

      });


      if (res.ok) {
        alert('Editado com sucesso');
        window.location.reload();
      }
      if (!res.ok) {
        window.location.href = "../cadastros/login-doador.html";
      }

    });

    let form1 = document.getElementById("btn-sair-sairconta")
    form1.addEventListener('click', async function (e) {
      e.preventDefault();

      try {
        const response = await fetch("/logout", {
          method: "POST",
          credentials: "include" // importante para enviar o cookie da sessão
        });

        const result = await response.json();
        console.log(result.message);

        if (response.ok) {
          // redirecionar para login
          window.location.href = "../cadastros/login-doador.html";
        }
      } catch (error) {
        console.error("Erro no logout:", error);
      }

    });
  </script>
    <script src="../js/funcionalidades.js"></script>
    <script src="../js/configuracao.js"></script>
        <script src="../js/search.js"></script>
              <script src="../js/carregamento.js"></script>
  </body>
</html>
