<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil</title>
  <link rel="stylesheet" href="../css/index.css" />
  <link rel="stylesheet" href="../css/pages/perfil/perfil.css" />
  <link rel="stylesheet" href="../css/partials/navbar.css" />
  <link rel="stylesheet" href="../css/pages/feed/feed.css" />
</head>

<body>
  <header>
    <!--Navbar-->
    <nav class="navbar">
      <div class="flex" style="justify-content: flex-start; width: 100%; gap: 1.5rem">
        <div style="line-height: 50px">
          <button class="hamburger" id="hamburger"></button>
        </div>
        <ul class="nav-links" id="navlinks">
          <li><a href="feed.html">Explorar</a></li>
          <li><a href="ongsFiltro.html">ONGs</a></li>
        </ul>
        <a class="nav-title" href="../ong/feed.html"><img src="../assets/svg/Logo UneONG FINAL.svg" alt="" width="80"
            height="80" /></a>
      </div>

      <input type="text" name="txtbuscar" id="txtbuscar" class="buscar" placeholder="Procure uma ong..." />
      <label for="txtbuscar"><img src="../assets/png/icones/icone_buscar.png" class="buscarIcon" alt=""></label>

      <div class="nav-elements" style="width: 100px; justify-content: flex-end; padding-left: 1rem">
        <div class="icon-menu">
          <img src="../assets/png/user-example.png" alt="" id="dropdown-perfil" />
        </div>
        <div class="dropdown" id="dropdownMenu">
          <div class="flex" style="width: 100%">
            <img class="foto-perfil" src="../assets/jpg/foto-perfil-exemplo.jpg" alt="" id="foto_perfil" />
            <div class="mn-part1">
              <p class="name-account" id="txtnomeOng">Cartinha Mágica</p>
              <p class="email-account" id="txtemailOng">cartinhamagica@gmail.com</p>
              <a class="perfil-account" href="perfil.html">Seu perfil ➞</a>
            </div>
          </div>
          <div class="mn-part2">
            <ul>
              <li><a href="configuracoes.html"><img src="../assets/png/icones/icone_configuracoes.png" alt=""
                    style="width: 25px; margin-right: 7px; vertical-align: middle;">Configurações</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <div id="overlay"></div>

  <!--Topo do perfil (fixo)-->

  <div class="header-perfil" style="padding-top: 50px">
    <img class="header-image" id="fotoHeader" src="" alt="" />
  </div>
  <div class="info-perfil">
    <div class="perfil-containt">
      <div class="div-1">
        <div class="icon-profile">
          <img src="" id="fotoPerfil" />
        </div>
        <h4 class="name-profile" id="txtnomeOngPerfil">Cartinha Mágica</h4>
      </div>
      <div class="div-2">
        <p><span>10</span> publicações</p>
        <p></p>
        <p><span id="txtseguidores"></span> seguidores</p>
      </div>
    </div>
  </div>

  <!--Coleções (fixo)-->

  <div class="main-perfil">
    <section class="feed-profile">
      <div class="flex main-left">
        <div class="itens-salvos">
          <div class="title-itens">
            <h4>Coleções</h4>
          </div>

          <div class="elementos-salvos">
            <div class="subcontainer-colecoes">
              <article class="item-colecao">
                <a class="icon-colecao">V</a>
                <a>Ver mais tarde</a>
              </article>

              <article class="item-colecao">
                <a class="icon-colecao">V</a>
                <a>Ver mais tarde</a>
              </article>
              <article class="item-colecao">
                <a class="icon-colecao">V</a>
                <a>Ver mais tarde</a>
              </article>

              <article class="item-colecao">
                <a class="icon-colecao">V</a>
                <a>Ver mais tarde</a>
              </article>
            </div>


            <div style="
                  width: 95%;
                  display: flex;
                  flex-direction: row;
                  justify-content: center;
                  margin: 1.5rem 0;
                ">
              <a class="nova-colecao" href="" id="abrirCriarColecao">Nova coleção</a>
            </div>
          </div>
        </div>

        <!--Mídia (fixo)-->

        <div class="container" id="link-midia" style="
              width: 350px;
              height: 20px;
              display: flex;
              padding: 1rem;
              flex-direction: row;
              align-items: center;
              cursor: pointer;
              justify-content: space-between;
            ">
          <h4>
            <a id="link-midia-text">Mídia</a>
          </h4>
          <a class="ver-tudo"> &gt;</a>
        </div>

      </div>

      <div class="flex main-right">
        <div class="flex" style="align-items: center; justify-content: center; width: 107%">

          <!--Menu sobre e postagens (fixo)-->
          <div class="menu-perfil">
            <article class="option-menu">
              <a id="link-sobre">Sobre</a>
            </article>
            <article class="option-menu">
              <a id="link-postagens">Postagens</a>
            </article>
          </div>
        </div>

        <!-- ********** Seção Postagens ********** -->
        <div id="secao-postagens"
          style="display: none; flex-direction: column; gap: 15px; transform: translateX(15px); ">
          <div class="create-post">
            <img src="../assets/jpg/foto-perfil-exemplo.jpg" alt="" id="foto_perfil3"/>
            <input type=" text" name="abrirModalCriarPost" id="abrirModalCriarPost"
              placeholder="Fazer publicação..." />
          </div>
          <div id="post-section"
            style="overflow-y: auto; max-height: 500px; display: flex; flex-direction: column; gap: 2rem;">
            <article class="post">
            </article>
          </div>
        </div>

        <!--********** Seção Sobre **********-->
        <div id="secao-sobre" style="display: none; flex-direction: column; gap: 15px; transform: translateX(20px);">
          <article class="sobreContainer">
            <div class="sobreCorpo">
              <h3 id="txtrazao_social">Razão social:</h3>
              <p id="txtdescricao">

              </p>
            </div>
            <div class="sobreFooter">
              <div style="display: flex; align-items: center; gap: 8px">
                <img src="../assets/png/icones/icone_calendario-fundacao-sobre.png" alt="" height="20px"
                  width="20px" /><span id="txtAdF">Fundada em </span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <img src="../assets/png/icones/icone_localizacao-sobre.png" alt="" height="20px" width="20px" /><span
                  id="txtcidade">Localizada em </span>
              </div>
            </div>
          </article>
        </div>

        <!-- ********** Seção Mídia **********-->
        <div id="secao-midia"
          style="display: none; flex-direction: column; gap: 15px; transform: translateX(-14px); width: 92%;">
          <article class="container" style="
              border: 1px solid #cdcccc;
              width: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: space-between;
              padding-bottom: 12px;
            ">
            <h4 style="
                width: 100%;
                padding-top: 10px;
                padding-bottom: 15px;
                border-bottom: 3px solid #dadada;
              ">
              Mídia
            </h4>

            <section class="fotos-container">
              <div class="foto">
                <img id="abrirAdicionarImagem" style="cursor: pointer;" src="../assets/png/icones/icone_adicionar+.png"
                  alt="" width="100%" height="100%" />
              </div>
            </section>

          </article>
        </div>

        <!-- ********** Seção Coleção ********** -->

        <div id="secao-colecao"
          style="display: none; flex-direction: column; gap: 15px; transform: translateX(-14px); width: 92%;">
          <article class="post">
            <div class="autor-post">
              <div class="flex" style="flex-direction: column;">
                <div class="flex">
                  <div class="autor-photo">
                    <img src="../assets/jpg/foto-perfil-exemplo.jpg" alt="" />
                  </div>
                  <a class="autor" href="../">Cartinha Mágica</a>
                </div>
                <span class="horario">Fev 26 às 19h19</span>
              </div>
              <div>
                <div class="options-container">
                  <a class="options-post" onclick="toggleOptions(this)">...</a>
                  <div class="dropdown-options">
                    <a class="btnEditarPost" style="cursor: pointer">Editar post</a>
                    <a class="btnSalvarPost" style="cursor: pointer">Salvar post</a>
                    <a class="btnExcluirPost" style="cursor: pointer">Excluir post</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="corpo-post">
              <p>
                Esse projeto tem o intuito de levar alegria e esperança para crianças que muitas vezes não têm condições
                de ter um Natal tão especial. A cada ano, voluntários se unem para arrecadar doações e organizar essa
                festa inesquecível.
              </p>
            </div>
            <div class="reactions-post">
              <div style="width: 100%; gap: 5px; align-items: center;" class="flex">
                <img src="../assets/png/icones/icone_curtir.png" width="16px" height="16px" alt="">
                <span style=" color: #a6a6a6; font-weight: bold; font-size: 13px;">100</span>
              </div>

              <a class="reaction">Curtir</a>
              <a class="reaction">Compartilhar</a>
            </div>
          </article>
        </div>

      </div>
    </section>
  </div>

  <!-- ********** MODAIS ********** -->

  <!--********** Criar Post modal **********-->
  <div id="criarPost">
    <div class="cabecalho-post">
      <div style="
            width: 95%;
            display: flex;
            justify-content: center;
            align-items: center;
          ">
        <h3>Criar Post</h3>
      </div>
      <a href="" class="sair" id="sairCriarPost">X</a>
    </div>
    <div class="corpo-post">
      <div class="informacoes-pessoais">
        <div class="perfilIcon" style="background-image: url(../assets/jpg/foto-perfil-exemplo.jpg)"></div>
        <p>Cartinha Mágica</p>
      </div>
      <textarea style=" resize: none; min-height: 20px;" name="" id="textPost"
        placeholder="No que você está pensando?"></textarea>
      <input type="file" name="imagemPost" id="imagemPost" style="display: none" accept="image/*,video/*" multiple />
      <label for="imagemPost" class="add-file-post">Adicionar ao Post</label>

      <div class="preview" style="min-width: 80%;" id="previewContainerPost"></div>

    </div>
    <div style="width: 100%; display: flex; justify-content: center">
      <button class="btn-publicar" id='SalvarP' type="submit" onclick="enviarPost()">Publicar</button>
    </div>
  </div>

  <!-- EDITAR POSTAGEM -->

  <div id="editarPost">
    <div class="cabecalho-post2">
      <div style="
            width: 95%;
            display: flex;
            justify-content: center;
            align-items: center;
          ">
        <h3>Editar Postagem</h3>
      </div>
      <a href="" class="sair" id="sairEditarPost">X</a>
    </div>
    <div class="corpo-post2">
      <div class="informacoes_pessoais2">
        <div class="perfilIcon" style="background-image: url(../assets/jpg/foto-perfil-exemplo.jpg)" id="foto_perfil4"></div>
        <p id="editarNomeOng">Cartinha Mágica</p>
      </div>
      <textarea style=" resize: none;" name="textPost2" id="textPost2"
        placeholder="No que você está pensando?"></textarea>
      <input type="file" name="" id="imagemPost2" style="display: none" />
      <label for="imagemPost2" class="add-file-post2">Adicionar Imagens</label>
      <div class="preview2" style="min-width: 80%;" id="previewContainerPost2"></div>
    </div>
    <div style="width: 100%; display: flex; justify-content: center">
      <a class="btn-salvar2" id="btnSalvarEdicao">Salvar</a>
    </div>
  </div>

  <!-- EXCLUIR POSTAGEM -->

  <div id="excluirPost">
    <div class="modal-header">
      <h1 class="modal-title">Excluir Publicação</h1>
      <button class="close-modal" id="fecharSaida">X</button>
    </div>

    <div class="modal-body">
      <div class="desc-excluirmodal">
        <span>Você tem certeza que deseja excluir publicação? </span>
      </div>

      <div class="opcoes-excluirmodal">
        <button id="btn-cancelar-excluirmodal">Cancelar</button>

        <button id="btnSairExcluirmodal">Excluir</button>
      </div>
    </div>
  </div>




  <!--********** Salvar Publicação Modal **********-->
  <div id="salvarPublicacao">
    <div class="cabecalho-post" style="border-bottom: 2px solid #f5f5f5">
      <div style="
            width: 95%;
            display: flex;
            justify-content: center;
            align-items: center;
          ">
        <h3 style="font-size: 12pt; color: #2c2f2c">Salvar em:</h3>
      </div>
      <a href="../" class="sair" id="sairSalvarPublicacao">X</a>
    </div>

    <div class="corpo-post">
      <div class="subcontainer">
        <label for="vermaistarde1">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde1" style="border-radius: 50%" />
      </div>
      <div class="subcontainer">
        <label for="vermaistarde2">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde2" style="border-radius: 50%" />
      </div>
      <div class="subcontainer">
        <label for="vermaistarde3">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde3" style="border-radius: 50%" />
      </div>
      <div class="subcontainer">
        <label for="vermaistarde4">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde4" style="border-radius: 50%" />
      </div>
      <div class="subcontainer">
        <label for="vermaistarde5">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde5" style="border-radius: 50%" />
      </div>
      <div class="subcontainer">
        <label for="vermaistarde6">Ver mais tarde</label>
        <input type="checkbox" name="vermaistarde" id="vermaistarde6" style="border-radius: 50%" />
      </div>
    </div>
    <br /><br />
    <div style="
          width: 100%;
          display: flex;
          justify-content: flex-end;
          padding: 1rem 0 0 0;
        ">
      <a href="../" class="btn-confirmar">Concluir</a>
    </div>
  </div>

  <!-- ********** Modal criar Colecao ********** -->
  <div id="criarColecao">
    <div class="modal-header">
      <h1 class="modal-title">Criar nova coleção</h1>
      <button class="close-modal" id="fecharCriarColecao">X</button>
    </div>

    <div class="modal-body">
      <div class="desc-criarcolecao">
        <span>Crie uma nova coleção para organizar seus itens salvos.</span>
      </div>

      <div class="form-criarcolecao">
        <form action="">
          <label for="nomeColecao">Nome da coleção</label>
          <input type="text" id="nomeColecao" name="nomeColecao" placeholder="Ex: Pets, Causa Infantil, etc" />

          <div class="botoes-criarcolecao">
            <button id="btn-cancelar-criarcolecao" type="button">
              Cancelar
            </button>

            <button id="btn-criar-criarcolecao" type="submit">
              Criar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Adicionar Imagem em Mídia -->
  <div id="adicionarImagemModal">
    <header class="modal-header">
      <h2 class="modal-title">Adicionar imagem</h2>
      <button id="closeModal" class="btn-close">&times;</button>
    </header>

    <label for="txtlegenda">Adicione uma legenda a imagem</label>
    <input type="text" id="txtlegenda" name="txtlegenda" placeholder="Legenda..." />
    <section class="modal-body">
      <label for="fileInput" class="drop-area">
        <img src="" alt="">
        <p>Escolha uma imagem</p>
        <input id="fileInput" name="fileInput" type="file" accept="image/*" />
      </label>

      <div class="preview" id="previewContainer"></div>
    </section>

    <footer class="modal-footer">
      <button id="cancelBtn" class="btn-secondary">Cancelar</button>
      <input type="submit" value="Adicionar" class="btn-add" id="btnEnviarMidia" />
    </footer>
  </div>

  <!--Modal foto aberta (post com foto)-->
  <div id="lightbox-modal" class="lightbox-hidden">
    <span class="lightbox-close" onclick="closeLightbox()">×</span>
    <img id="lightbox-img" src="" alt="Imagem em destaque" />
    <button id="lightbox-prev" onclick="navigateLightbox(-1)">
      <img src="../assets/png/arrowuneong.png" alt="Anterior" />
    </button>
    <button id="lightbox-next" onclick="navigateLightbox(1)">
      <img src="../assets/png/arrowuneong.png" alt="Próxima" />
    </button>
  </div>


  <script>
    window.onload = async () => {
      try {
        const res = await fetch("/api/config", {
          method: "GET",
          credentials: "include" // necessário para enviar o cookie da sessão
        });
        const data = await res.json();

        if (!res.ok) {
          alert(data.error);
          // redireciona
          window.location.href = "../cadastros/login-doador.html";
          return;
        }



        //IMAGENS
        document.getElementById("fotoPerfil").src = data.foto_perfil_ong;
        document.getElementById("fotoHeader").src = data.foto_header_ong;
        document.getElementById("foto_perfil3").src = data.foto_perfil_ong;

        //INFORMAÇÕES
        document.getElementById("txtnomeOng").textContent = data.nome_ong;
        document.getElementById("txtseguidores").textContent = data.seguidores;
        document.getElementById("txtnomeOngPerfil").textContent = data.nome_ong;
        document.getElementById("txtrazao_social").textContent = 'Razão Social: ' + data.razao_social;
        document.getElementById("txtemailOng").textContent = data.email_ong;
        document.getElementById("txtdescricao").textContent = data.descrição;
        document.getElementById("txtAdF").textContent = 'Fundada em ' + data.AdF;
        document.getElementById("foto_perfil").src = data.foto_perfil_ong;
        const foto = document.getElementById("foto_perfil4");
        foto.style.backgroundImage  = `url(${data.foto_perfil_ong})`;
        document.getElementById("editarNomeOng").textContent = data.nome_ong;

        document.getElementById("txtcidade").textContent = 'Localizada em ' + data.cidade;
        console.log(data)
        console.log("ID DA ONG -> " + data.id_ong)
        carregarMidias(data.id_ong);

      } catch (err) {
        console.error("Erro ao carregar dados:", err);
      }


    };



    async function enviarPost() {
      const textPost = document.getElementById("textPost").value;
      const files = document.getElementById("imagemPost").files;

      const formData = new FormData();


      formData.append("textPost", textPost);

      // até 4 arquivos
      for (let i = 0; i < files.length && i < 4; i++) {
        formData.append("imagemPost", files[i]);
      }

      const response = await fetch("/api/posts", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();
      console.log(result);
      if (response.ok) {
        alert("Post criado com sucesso")
        carregarFeed();
        window.location.reload();
      }
      if (!response.ok) {
        alert(result.error)
      }

    }

    async function carregarFeed() {
      const res = await fetch("/api/perfil", {
        method: "GET",
        credentials: "include"
      });
      const posts = await res.json();

      const feedDiv = document.getElementById("post-section");
      feedDiv.innerHTML = `<div id="post-section"style="display: none; flex-direction: column; gap: 15px; transform: translateX(15px);"`;

      posts.forEach(post => {
        const postDiv = document.createElement("article");
        postDiv.classList.add("post");


        const midias = Array.isArray(post.imagem_url)
          ? post.imagem_url
          : JSON.parse(post.imagem_url || "[]");

        const midia = midias.map(url => {
          return url.endsWith(".mp4")
            ? `<video controls src="${url}"></video>`
            : `<img src="${url}" />`;
        }).join("");



        postDiv.innerHTML = `
      <div class="autor-post">
        <div class="flex" style="flex-direction: column">
          <div class="flex">
            <div class="autor-photo">
              <img src="${post.ONG.foto_perfil_ong}" alt="" />
            </div>
            <a class="autor" href="../">${post.ONG?.nome_ong || "ONG desconhecida"}</a>
          </div>
          <span class="horario">
            ${new Date(post.data_hora).toLocaleString("pt-BR")}
          </span>
        </div>
        <div>
          <div class="options-container" data-id="${post.id_post}">
            <a class="options-post">...</a>
            <div class="dropdown-options">
              <a class="btnEditarPost" style="cursor: pointer">Editar post</a>
              <a class="btnSalvarPost" style="cursor: pointer">Salvar post</a>
              <a class="btnExcluirPost" style="cursor: pointer">Excluir post</a>
            </div>
          </div>
        </div>
      </div>

      <div class="corpo-post">
        <p>${post.conteudo_post}</p>
        <div class="fotos-post">
          ${midia}
        </div>
      </div>
      <div class="reactions-post">
        <div style="width: 100%; gap: 5px; align-items: center;" class="flex">
          <img src="../assets/png/icones/icone_curtir.png" width="16px" height="16px" alt="">
          <span style=" color: #a6a6a6; font-weight: bold; font-size: 13px;">0</span>
        </div>
        <a class="reaction">Curtir</a>
        <a class="reaction">Compartilhar</a>
      </div>
    `;

        feedDiv.appendChild(postDiv);

      });
    }

    carregarFeed();

    function configurarEventosPosts() {

      // ==== salvar alterações ====

      document.querySelectorAll(".options-post").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const container = btn.parentElement;
          container.classList.toggle("active");
          e.stopPropagation();
        });
      });

      let arquivosSelecionadosEditar = []; // novos uploads
      let arquivosExistentesEditar = [];   // já salvos no banco
      const LIMITE_MIDIAS = 4;

      const previewContainerEditar = document.getElementById("previewContainerPost2");
      const fileInputEditar = document.getElementById("imagemPost2");

      // ==== renderiza preview ====
      function mostrarPreviewEditar() {
        previewContainerEditar.innerHTML = "";

        // mídias existentes
        arquivosExistentesEditar.forEach((url, index) => {
          const wrapper = criarPreview(url, null, index, "existente");
          previewContainerEditar.appendChild(wrapper);
        });

        // mídias novas
        arquivosSelecionadosEditar.forEach((file, index) => {
          const wrapper = criarPreview(URL.createObjectURL(file), file, index, "novo");
          previewContainerEditar.appendChild(wrapper);
        });
      }

      function criarPreview(src, file, index, tipo) {
        const wrapper = document.createElement("div");
        wrapper.style.cssText =
          "position:relative;display:inline-block;margin:5px;width:100px;height:100px;border:1px solid #ddd;border-radius:10px;overflow:hidden;";

        if (file && file.type.startsWith("video") || (src.endsWith(".mp4"))) {
          const video = document.createElement("video");
          video.src = src;
          video.controls = true;
          video.style.cssText = "width:100%;height:100%;object-fit:cover;";
          wrapper.appendChild(video);
        } else {
          const img = document.createElement("img");
          img.src = src;
          img.style.cssText = "width:100%;height:100%;object-fit:cover;";
          wrapper.appendChild(img);
        }

        // botão excluir
        const btn = document.createElement("button");
        btn.textContent = "✕";
        btn.style.cssText =
          "position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;cursor:pointer;width:20px;height:20px;";
        btn.addEventListener("click", () => {
          if (tipo === "existente") {
            arquivosExistentesEditar.splice(index, 1);
          } else {
            arquivosSelecionadosEditar.splice(index, 1);
          }
          mostrarPreviewEditar();
        });

        wrapper.appendChild(btn);
        return wrapper;
      }

      // ==== input para novas mídias ====
      if (fileInputEditar) {
        fileInputEditar.addEventListener("change", (e) => {
          let novosArquivos = Array.from(e.target.files);

          // filtrar duplicados


          const totalAtual = arquivosExistentesEditar.length + arquivosSelecionadosEditar.length;
          const vagas = LIMITE_MIDIAS - totalAtual;

          if (novosArquivos.length > vagas) {
            alert(`Você não pode adicionar mais mídias.`);
          }

          // adiciona só o que couber
          arquivosSelecionadosEditar = arquivosSelecionadosEditar.concat(novosArquivos.slice(0, vagas));

          mostrarPreviewEditar();
          fileInputEditar.value = ""; // limpa input para permitir novo upload
        });
      }
      // ==== carregar post no modal ====
      async function carregarPostNoModal(idPost) {
        const res = await fetch(`/api/posts/${idPost}`);
        const post = await res.json();

        // texto
        document.getElementById("textPost2").value = post.conteudo_post;

        // mídias já salvas
        arquivosExistentesEditar = Array.isArray(post.imagem_url) ? post.imagem_url : [];
        arquivosSelecionadosEditar = [];

        mostrarPreviewEditar();
      }

      async function editarPost(idPost) {
        document.getElementById("btnSalvarEdicao").addEventListener("click", async () => {

          const texto = document.getElementById("textPost2").value;

          const formData = new FormData();
          formData.append("conteudo_post", texto);
          formData.append("imagensExistentes", JSON.stringify(arquivosExistentesEditar));

          // novas imagens selecionadas
          arquivosSelecionadosEditar.forEach((file) => {
            formData.append("novasMidias", file);
          });

          await fetch(`/api/posts/update/${idPost}`, {
            method: "PUT",
            body: formData,
            credentials: "include"
          });
          alert("Post atualizado!");
          window.location.reload();
          carregarFeed().then(() => configurarEventosPosts(), recarregarCSS());

        });

      }

      async function deletarpost(idPost) {
        document.getElementById("btnSairExcluirmodal").addEventListener("click", async () => {

          const res = await fetch(`/api/posts/${idPost}`, {
            method: "DELETE",
          });

          const data = await res.json();
          if (res.ok) {
            alert("Post excluído!");
            carregarFeed();
            window.location.reload();
            carregarFeed().then(() => configurarEventosPosts(), recarregarCSS());
          } else {
            alert("Erro: " + data.error);
          }

        });

      }

      document.querySelectorAll(".btnSalvarPost").forEach((btn) => {
        btn.addEventListener("click", () => {
          abrir(document.getElementById("salvarPublicacao"));
        });
      });


      document.querySelectorAll(".btnExcluirPost").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idPost = e.target.closest(".options-container").dataset.id;
          console.log("Excluir post com ID:", idPost);

          abrir(document.getElementById("excluirPost"));

          // Armazena o id do post que vai ser excluído
          deletarpost(idPost)
          document.getElementById("btn-sair-excluirmodal").dataset.id = idPost;

        });

      });

      document.querySelectorAll(".btnEditarPost").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idPost = e.target.closest(".options-container").dataset.id;
          console.log("Editar post com ID:", idPost);

          // Abre modal de edição
          abrir(document.getElementById("editarPost"));

          // Preenche o modal com dados do post (chamando API ou pegando direto do DOM)
          carregarPostNoModal(idPost);
          editarPost(idPost);

        });
      });

    }

    // ==== salvar alterações ====



    function recarregarCSS() {
      const link2 = document.querySelector('link[href="../css/pages/perfil/perfil.css"]');
      link2.href = link2.href + "?v=" + Date.now();

      const link = document.querySelector('link[href="../css/partials/navbar.css"]');
      link.href = link.href + "?v=" + Date.now();

      const link1 = document.querySelector('link[href="../css/index.css"]');
      link1.href = link1.href + "?v=" + Date.now();
    }







    //scripts para esconder/aparecer as seções

    const secaoSobre = document.getElementById("secao-sobre");
    const secaoPostagens = document.getElementById("secao-postagens");
    const secaoMidia = document.getElementById("secao-midia");
    const secaoColecao = document.getElementById("secao-colecao");

    const linkSobre = document.getElementById("link-sobre");
    const linkPostagens = document.getElementById("link-postagens");
    const linkMidia = document.getElementById("link-midia");
    const linkMidiaText = document.getElementById("link-midia-text");
    const linkColecao = document.querySelectorAll(".item-colecao");

    secaoSobre.style.display = "flex";
    linkSobre.style.color = "#e74c3c";

    //evento de clicar no botao de postagens
    linkPostagens.addEventListener("click", () => {
      secaoPostagens.style.display = "flex";
      secaoSobre.style.display = "none";
      secaoMidia.style.display = "none";
      secaoColecao.style.display = "none";

      linkPostagens.style.color = "#e74c3c";
      linkPostagens.style.fontWeight = "bold";
      linkSobre.style.color = "";
      linkMidiaText.style.color = "";
      linkColecao.forEach(el => {
        el.style.color = "";
        el.style.fontWeight = "";
      });
    });

    //evento de clicar no botao de sobre
    linkSobre.addEventListener("click", () => {
      secaoSobre.style.display = "flex";
      secaoPostagens.style.display = "none";
      secaoMidia.style.display = "none";
      secaoColecao.style.display = "none";

      linkSobre.style.color = "#e74c3c";
      linkSobre.style.fontWeight = "bold";
      linkPostagens.style.color = "";
      linkMidiaText.style.color = "";
      linkColecao.forEach(el => {
        el.style.color = "";
        el.style.fontWeight = "";
      });
    });

    //evento de clicar no botao de midia
    linkMidia.addEventListener("click", () => {
      secaoMidia.style.display = "flex";
      secaoPostagens.style.display = "none";
      secaoSobre.style.display = "none";
      secaoColecao.style.display = "none";

      linkMidiaText.style.color = "#e74c3c";
      linkMidiaText.style.fontWeight = "bold";
      linkSobre.style.color = "";
      linkPostagens.style.color = "";
      linkColecao.forEach(el => {
        el.style.color = "";
        el.style.fontWeight = "";
      });
    });

    //evento de clicar no botao de colecao
    linkColecao.forEach(element => {
      element.addEventListener("click", function () {
        secaoColecao.style.display = "flex";
        secaoPostagens.style.display = "none";
        secaoSobre.style.display = "none";
        secaoMidia.style.display = "none";

        // Remove destaque de todos
        linkColecao.forEach(el => {
          el.style.color = "";
          el.style.fontWeight = "";
        });

        // Destaca apenas o clicado
        element.style.fontWeight = "bold";
        element.style.color = "#e74c3c";

        linkMidiaText.style.color = "";
        linkSobre.style.color = "";
        linkPostagens.style.color = "";
      });
    });

    //script de midias

    // adicionar mídia
    const btnAdicionar = document.getElementById("btnEnviarMidia");
    btnAdicionar.addEventListener("click", async () => {
      const descricao = document.getElementById("txtlegenda").value;
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file) {
        alert("Selecione um arquivo!");
        return;
      }

      console.log("Arquivo recebido:", file);

      const formData = new FormData();
      formData.append("txtlegenda", descricao);
      formData.append("fileInput", file, file.name);


      const res = await fetch("/api/midias", {
        method: "POST",
        body: formData,
        credentials: "include"
      });

      if (res.ok) {
        alert("Mídia adicionada!");
        carregarMidias();
        window.location.reload();

      } else {
        const err = await res.json();
        alert("Erro: " + err.error);
      }


    });

    // ver as miniaturas das midias
    async function carregarMidias(idPerfil) {
      if (!idPerfil) return; // evita undefined

      const id = Number(idPerfil); // garante que seja número
      if (isNaN(id)) {
        console.error("ID inválido para carregar mídias:", idPerfil);
        return;
      }

      try {
        const res = await fetch(`/api/midias/${id}`, { credentials: "include" });
        const midias = (await res.json()) || [];
        if (!Array.isArray(midias)) {
          console.error("Mídias não é array:", midias);
          return;
        }

        const fotosContainer = document.querySelector("#secao-midia .fotos-container");
        fotosContainer.querySelectorAll("article").forEach(a => a.remove());

        midias.forEach(midia => {
          const urls = Array.isArray(midia.imagem_midia) ? midia.imagem_midia : [midia.imagem_midia];

          urls.forEach(url => {
            const article = document.createElement("article");
            article.classList.add("foto");
            article.style.cursor = "pointer";
            article.style.width = "100%";
            article.style.height = "100%";
            article.style.margin = "5px 0";

            if (url.match(/\.(mp4|webm|ogg)$/i)) {
              const video = document.createElement("video");
              video.src = url;
              video.controls = true;
              video.width = 100;
              video.height = 100;
              article.appendChild(video);
            } else {
              article.style.background = `url(${url})`;
              article.style.backgroundSize = "cover";
              article.style.backgroundPosition = "center";
              article.style.width = "100px";
              article.style.height = "100px";
            }

            article.addEventListener("click", () => abrirVisualizacaoMidia(url, midia.descricao_midia, midia.ONG?.nome_ong));
            fotosContainer.appendChild(article);
          });
        });

      } catch (err) {
        console.error("Erro ao carregar mídias:", err);
      }
    }


    // Modal para visualização
    function abrirVisualizacaoMidia(url, descricao, criador) {
      // Overlay
      let overlay = document.getElementById("overlay");
      if (!overlay) {
        overlay = document.createElement("div");
        overlay.id = "overlay";
        overlay.style.position = "fixed";
        overlay.style.top = "0";
        overlay.style.left = "0";
        overlay.style.width = "100%";
        overlay.style.height = "100%";
        overlay.style.background = "rgba(0,0,0,0.7)";
        overlay.style.display = "none";
        overlay.style.zIndex = "999";
        document.body.appendChild(overlay);

        overlay.addEventListener("click", () => {
          modalPost.style.display = "none";
          overlay.style.display = "none";
        });
      }

      // Modal
      let modalPost = document.getElementById("modalPost");
      if (!modalPost) {
        modalPost = document.createElement("div");
        modalPost.id = "modalPost";
        modalPost.style.display = "none";
        modalPost.style.position = "fixed";
        modalPost.style.top = "50%";
        modalPost.style.left = "50%";
        modalPost.style.transform = "translate(-50%, -50%)";
        modalPost.style.zIndex = "1000";

        modalPost.innerHTML = `
      <div style="display: flex; width: 70%; height: 100%; flex-direction: column; justify-content: space-between; align-items: center;">
        <div style="width: 100%; display: flex; align-items: center; padding: 0; height: 10px;">
          <a href="" class="sair" style="font-weight: bold;">×</a>
        </div>
        <div id="midia-viewer" class="photo-post" style="display: flex; justify-content: center; align-items: center;">
          <img id="midia-img" src="" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
        </div>
      </div>
      <div style="width: 30%; border-left: 3px solid #f5f5f5; border-radius: 0 10px 10px 0; display: flex; flex-direction: column; justify-content: flex-start;">
        <div style="border-bottom: 3px solid #f5f5f5; display: flex; align-items: center; padding: 1rem;"><p class="autor" id="criadorMidia"></p></div>
        <article class="postInfo">
          <div style="display: flex; width: 100%; padding-left: 2.5rem; height: 20px; align-items: flex-start; justify-content: flex-start;">
            <a class="info">${new Date(modalPost.data_midia).toLocaleString("pt-BR")}</a>
          </div>
          <p class="txtPost" id="midia-descricao"></p>
        </article>
      </div>
    `;

        document.body.appendChild(modalPost);

        // Botão fechar
        const closeBtn = modalPost.querySelector(".sair");
        closeBtn.addEventListener("click", (e) => {
          e.preventDefault();
          modalPost.style.display = "none";
          overlay.classList.remove("show");
        });
      }

      // Atualiza imagem e descrição
      const midiaImg = document.getElementById("midia-img");
      const midiaDescricao = document.getElementById("midia-descricao");
      const criadorMidia = document.getElementById("criadorMidia");
      midiaImg.src = url;
      midiaDescricao.textContent = descricao;
      criadorMidia.textContent = criador;

      // Exibe modal e overlay
      overlay.classList.toggle("show");
      modalPost.style.display = "flex";

      overlay.addEventListener("click", () => {
        modalPost.style.display = "none";
        overlay.classList.remove("show");
      });

    }



    // Chama a função para carregar as mídias
    carregarMidias();

    carregarFeed().then(() => configurarEventosPosts(), recarregarCSS());


  </script>


  <script src="../js/funcionalidades.js"></script>
  <script src="../js/modals/modalPost.js"></script>
  <script src="../js/feed.js"></script>
</body>

</html>